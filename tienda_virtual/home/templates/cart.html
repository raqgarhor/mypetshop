{% extends 'base.html' %}
{% load cart_extras %}

{% block title %}Carrito - My Pet Shop{% endblock %}

{% block content %}
    <h2>Tu carrito</h2>
    {% if items %}
        <table class="cart-table">
            <thead>
                <tr><th>Producto</th><th>Cantidad</th><th>Acciones</th><th>Subtotal</th></tr>
            </thead>
            <tbody>
                {% for it in items %}
                    <tr>
                            <td>{{ it.producto.nombre }}{% if it.size %} - Talla: {{ it.size }}{% endif %}</td>
                        <td>
                            <form action="{% url 'cart_update' %}" method="post" style="display:inline">
                                {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ it.producto.id }}">
                                    <input type="hidden" name="size" value="{{ it.size }}">
                                <input type="number" name="quantity" value="{{ it.cantidad }}" min="0" style="width:60px"> 
                                <button type="submit" class="btn">Actualizar</button>
                            </form>
                        </td>
                        <td>
                                {% with key=it.producto.id|stringformat:"s"|add:":"|add:it.size %}
                                    {% with remaining=cart_remaining_by_item|get_item:key %}
                                        <form action="{% url 'add_to_cart' it.producto.id %}" method="post" style="display:inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="size" value="{{ it.size }}">
                                            <button type="submit" class="btn small" {% if remaining <= 0 %}disabled{% endif %}>+</button>
                                        </form>
                                    {% endwith %}
                                {% endwith %}
                                <form action="{% url 'cart_decrement' it.producto.id %}" method="post" style="display:inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="size" value="{{ it.size }}">
                                    <button type="submit" class="btn small">-</button>
                                </form>
                                <form action="{% url 'cart_remove' it.producto.id %}" method="post" style="display:inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="size" value="{{ it.size }}">
                                    <button type="submit" class="btn danger small">Eliminar</button>
                                </form>
                        </td>
                        <td>{{ it.subtotal }} €</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="cart-total">Total: {{ total }} €</p>
    {% else %}
        <p>Tu carrito está vacío.</p>
    {% endif %}
{% endblock %}
